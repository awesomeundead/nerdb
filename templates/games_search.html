<div id="games">
    <div class="advice">Não achou o jogo que queria? Torne nossa comunidade mais completa: entre e adicione o jogo você mesmo.</div>
    <div class="pagination" hidden="hidden">
        <div class="content">
            <button class="previous" type="button">Anterior</button>
            <button class="next" type="button">Próximo</button>
        </div>
    </div>
    <div class="container"></div>
</div>
<template>
    <div class="item">
        <div class="image">
            <a>
                <img />
            </a>
        </div>
        <div class="content">
            <div>
                <div class="title"></div>
            </div>
            <div class="flex_column">
                <div class="label">Desenvolvedor:</div>
                <div class="developer"></div>
            </div>
        </div>
    </div>
</template>

<script>

const list = new ContentList(
{
    url: 'api/v1/games',
    containerSelector: '#games .container',
    templateSelector: 'template',
    pagination: true,
    render: (json, container, template) =>
    {
        const items = json.games || [];

        container.innerHTML = '';

        items.forEach(item =>
        {
            const clone = template.content.cloneNode(true);
            const developers = item.developer.split(';');

            developers.forEach(developer =>
            {
                const element = document.createElement('a');
                element.href = `games/search?q=desenvolvedor:${developer}`;
                element.textContent = developer;
                clone.querySelector('.developer').appendChild(element);
            });

            clone.querySelector('a').href = `game/${item.id}/${item.title_url}`;
            clone.querySelector('img').src = item.media?.trim() ? `images/games/256/${item.media}.webp` : 'noimage.png';
            clone.querySelector('.title').textContent =  `${item.title} (${item.release_year})`;

            container.appendChild(clone);
        });
    }
});

document.querySelector('.pagination .next').addEventListener('click', () => list.next());
document.querySelector('.pagination .previous').addEventListener('click', () => list.previous());

search.addEventListener('submit', e =>
{
    if (search.action == 'games')
    {
        e.preventDefault();

        const url = new URL(window.location);
        url.searchParams.set('q', search.q.value);
        window.history.replaceState({}, '', url);

        document.title = search_game(search.q.value);
        list.init();
    }
});

if (query.has('q'))
{
    search.q.value = query.get('q');
    document.title = search_game(query.get('q'));
    list.init();
}

function search_game(value)
{
    const filters =
    {
        'desenvolvedor': 'developer',
        'genero': 'genre'
    };

    const match = value.match(/^(\w+):(.+)/);
    
    if (match && filters[match[1]])
    {
        list.setQueryParams({ [filters[match[1]]]: match[2], 'offset': 0 });
        return match[2];
    }

    if (/^\d{4}$/.test(value))
    {
        list.setQueryParams({ 'release': value, 'offset': 0 });
        return value;
    }

    list.setQueryParams({ 'search': value, 'offset': 0 });
    return value;
}

</script>