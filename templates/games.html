<div class="grid" id="movies"></div>
<template>
    <div class="item flex_column">
        <div class="image">
            <a>
                <img />
            </a>
        </div>
        <div class="info flex_row">
            <div>
                <div class="title"></div>
            </div>
            <div class="flex_column">
                <div>Desenvolvedor:</div>
                <div class="developer flex_column"></div>
            </div>
            <div class="flex_column">
                <div>Lan√ßamento:</div>
                <div class="release_year"></div>
            </div>
            <div class="steam">
                <a target="_blank">Steam</a>
            </div>
        </div>
    </div>
</template>

<script>

const query = new URLSearchParams(window.location.search);
const container = document.querySelector('#movies');
const template = document.querySelector('template');
const url = new URL('api/v1/games', document.baseURI);
const searchParams = url.searchParams;

const render = function({ games })
{
    container.innerHTML = '';

    games.forEach(item =>
    {
        const clone = template.content.cloneNode(true);
        const developers = item.developer.split(';');

        developers.forEach(developer =>
        {
            const element = document.createElement('a');
            element.href = `games?q=desenvolvedor:${developer}`;
            element.textContent = developer;
            clone.querySelector('.developer').appendChild(element);
        });

        clone.querySelector('a').href = `game/${item.id}`;
        clone.querySelector('img').src = item.media?.trim() ? `images/games/256/${item.media}.webp` : 'noimage.png';
        clone.querySelector('.title').textContent =  item.title;
        clone.querySelector('.release_year').textContent =  item.release_year;
        clone.querySelector('.steam a').href =  `https://steampowered.com/app/${item.steam}/`;

        if (!item.steam)
        {
            clone.querySelector('.steam').remove();
        }

        container.appendChild(clone);
    });
}

search.addEventListener('submit', e =>
{
    if (search.action == 'games')
    {
        e.preventDefault();

        const url = new URL(window.location);
        url.searchParams.set('q', search.q.value);
        window.history.replaceState({}, '', url);

        document.title = search_game(search.q.value);
        getJSON();
    }
});

if (query.has('q'))
{
    search.q.value = query.get('q');
    document.title = search_game(query.get('q'));
    getJSON();
}
else
{
    getJSON();
    document.title = 'Jogos';
}

document.addEventListener('DOMContentLoaded', () =>
{
    const select = search.querySelector('select');
    select.value = 'games';
    select.dispatchEvent(new Event('change'));
});

function search_game(value)
{
    const filters =
    {
        'desenvolvedor': 'developer',
        'genero': 'genre'
    };

    const match = value.match(/^(\w+):(.+)/);
    
    if (match && filters[match[1]])
    {
        searchParams.set(filters[match[1]], match[2]);
        return match[2];
    }

    if (/^\d{4}$/.test(value))
    {
        searchParams.set('release', value);
        return value;
    }

    searchParams.set('search', value);
    return value;
}

</script>