<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Filmes</title>
<link href="layout.css" rel="stylesheet" />
<link href="default.css" rel="stylesheet" />
</head>
<body>

<div id="app">
    <header>
        <nav>
            <a href="my_movie_list.html">Minha lista de filmes</a>
            <a href="friends.html">Meus amigos</a>
            <a href="movies.html">Filmes cadastrados</a>
            <a href="add_movie.html">Adicionar filme</a>
        </nav>
        <div>
            <form id="search">
                <input name="q" placeholder="Pesquisar por título ou lançamento" type="search" />
                <button type="submit">Ok</button>
            </form>
        </div>
    </header>
    <template>
        <div class="item flex_column">
            <div class="image">
                <img alt="" height="128" src="" />
            </div>
            <div class="flex_row">
                <div>
                    <div class="title_br"></div>
                </div>
                <div class="flex_column">
                    <div>Título em inglês:</div>
                    <div class="title_us"></div>
                </div>
                <div class="flex_column">
                    <div>Lançamento:</div>
                    <div class="release_year"></div>
                </div>
                <div class="imdb">
                    <a href="" target="_blank">IMDB</a>
                </div>
                <div class="update">
                    <a href="update_movie.html">Editar</a>
                </div>
                <div class="add">
                    <button type="button">Adicionar a minha lista</button>
                </div>
            </div>
        </div>
    </template>
    <div id="movies"></div>
</div>


<script>

const query = new URLSearchParams(window.location.search);
const container = document.getElementById('movies');
const template = document.querySelector('template');
const search = document.querySelector('#search');

search.addEventListener('submit', e =>
{
    e.preventDefault();

    load_movies(`api/v1/movies?search=${search.q.value}`);
});

if (query.has('release'))
{
    load_movies(`api/v1/movies?release=${query.get('release')}`);
}
else
{
    load_movies('api/v1/movies');
}

function load_movies(url)
{
    fetch(url)
    .then(response =>
    {
        if (!response.ok)
        {
            throw new Error(response.statusText);
        }

        return response.json();
    })
    .then(json =>
    {
        render_movies(json.movies)
    })
    .catch(error =>
    {
        console.error(error);
    });
}

function addmovie(id, button)
{
    fetch('api/v1/user/addmovie/' + id,
    {
        method: 'post'
    })
    .then(response =>
    {
        if (!response.ok)
        {
            throw new Error(response.statusText);
        }

        return response.json();
    })
    .then(json =>
    {
        if (json.status == 'success')
        {
            button.remove();
        }

        console.log(json);
    })
    .catch(error =>
    {
        console.error(error);
    });
}

function render_movies(movies)
{
    container.innerHTML = '';

    movies.forEach(item =>
    {
        const clone = template.content.cloneNode(true);

        clone.querySelector('img').src =  `public/images/256/${item.media}.webp`;
        clone.querySelector('.title_br').textContent =  item.title_br;
        clone.querySelector('.title_us').textContent =  item.title_us;
        clone.querySelector('.release_year').textContent =  item.release_year;
        clone.querySelector('.imdb a').href =  `https://www.imdb.com/pt/title/${item.imdb}/`;
        clone.querySelector('.update a').href +=  `?id=${item.id}`;

        clone.querySelector('.add button').addEventListener('click', e => 
        {
            addmovie(item.id, e.target);
        });

        container.appendChild(clone);
    });
}

</script>

</body>
</html>