<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lista de filmes do meu amigo</title>
<link href="layout.css?180725" rel="stylesheet" />
<link href="default.css?180725" rel="stylesheet" />
<script src="auth.js?180725"></script>
</head>
<body>

<div id="app">
    <header>
        <nav>
            <a href="index.html">Início</a>
            <a href="top_movies.html">Top filmes</a>
            <a href="my_movie_list.html">Minha lista de filmes</a>
            <a href="friends.html">Meus amigos</a>
            <a href="add_movie.html">Adicionar filme</a>
        </nav>
    </header>
    <section>
        <div class="flex_row" id="my_movie_list_checkbox">
            <div class="flex_column vcenter">
                <input data-filter="watchlist" id="watchlist_checkbox" type="checkbox" />
                <label for="watchlist_checkbox">Filmes que seu amigo quer assistir</label>
            </div>        
            <div class="flex_column vcenter">
                <input data-filter="watched" id="watched_checkbox" type="checkbox" />
                <label for="watched_checkbox">Filmes que seu amigo assistiu</label>
            </div>
            <div class="flex_column vcenter">
                <input data-filter="liked" id="liked_checkbox" type="checkbox" />
                <label for="liked_checkbox">Filmes que seu amigo gostou</label>
            </div>
            <div class="flex_column vcenter">
                <input data-filter="rating" id="rating_checkbox" type="checkbox" />
                <label for="rating_checkbox">Filmes que seu amigo melhor avaliou</label>
            </div>
        </div>
        <div id="my_movie_list">
            <div class="grid"></div>
        </div>
    </section>
</div>

<template>
    <div class="item flex_row">
        <div class="flex_column">
            <div class="image">
                <a href="">
                    <img alt="" src="" />
                </a>
            </div>

            <div class="flex_row">
                <div class="flex_column">
                    <div aria-label="Quer assistir" class="icon friend friend_watchlist" title="Quer assistir">
                        <img alt="" src="saved.png" />
                    </div>
                    <div aria-label="Quero assistir" class="icon watchlist" title="Quero assistir">
                        <img alt="" src="saved.png" />
                    </div>
                </div>

                <div class="flex_column">
                    <div aria-label="Já assistiu" class="icon friend friend_watched" title="Já assistiu">
                        <img alt="" src="watched.png" />
                    </div>
                    <div aria-label="Já assisti" class="icon watched" title="Já assisti">
                        <img alt="" src="watched.png" />
                    </div>
                </div>

                <div class="flex_column">
                    <div aria-label="Gostou" class="icon friend friend_liked" title="Gostou">
                        <img alt="" src="liked.png" />
                    </div>
                    <div aria-label="Gostei" class="icon liked" title="Gostei">
                        <img alt="" src="liked.png" />
                    </div>
                </div>

                <div class="flex_column">
                    <div aria-label="Avaliação" class="icon_rating friend friend_rating" title="Avaliação"></div>
                    <div aria-label="Minha avaliação" class="icon_rating rating" title="Minha avaliação"></div>
                </div>
            </div>
        </div>
        <div class="flex_row">
            <div>
                <div class="title_br"></div>
            </div>
        </div>
    </div>
</template>

<script>

/*
 * Verifica se o usuário esta logado
 */
check_login();

const query = new URLSearchParams(window.location.search);
const container = document.querySelector('#my_movie_list .grid');
const template = document.querySelector('template');
const filter = {};

document.querySelectorAll('#watchlist_checkbox, #watched_checkbox, #liked_checkbox, #rating_checkbox').forEach(item =>
{
    item.addEventListener('click', () =>
    {
        if (item.checked)
        {
            filter[item.dataset.filter] = 1;
        }
        else
        {
            delete filter[item.dataset.filter];
        }

        load_movies();
    });
});

load_movies();

function load_movies()
{
    if (!query.has('id'))
    {
        /* corrigir futuramente */
        return;
    }

    let url = `api/v1/movie-list/user/${query.get('id')}`;

    if (Object.keys(filter).length)
    {
        url += '?' + new URLSearchParams(filter).toString();
    }

    fetch(url)
    .then(response =>
    {
        if (!response.ok)
        {
            throw new Error(response.statusText);
        }

        return response.json();
    })
    .then(json =>
    {
        render_movies(json.movies)
    })
    .catch(error =>
    {
        console.error(error);
    });
}

function render_movies(movies)
{
    if (!movies.length)
    {
        container.innerHTML = '<div class="centralizado">Não foram encontrados filmes nesta lista.</div>';

        return;
    }

    container.innerHTML = '';

    const disable = (clone, selector, condition = true) =>
    {
        const element = clone.querySelector(selector);

        if (condition)
        {
            element.classList.add('disable');
        }
    }

    movies.forEach(item =>
    {
        const clone = template.content.cloneNode(true);

        clone.querySelector('a').href = `movie.html?id=${item.id}`;
        clone.querySelector('.image img').src = item.media?.trim() ? `public/images/256/${item.media}.webp` : 'public/noimage.png';
        clone.querySelector('.title_br').textContent =  item.title_br;

        if (!item.watchlist || item.watched)
        {
            disable(clone, '.friend_watchlist');
        }

        disable(clone, '.friend_watched', !item.watched);
        disable(clone, '.friend_liked', !item.liked);

        if (item.rating)
        {
            clone.querySelector('.friend_rating').textContent = item.rating;
        }
        else
        {
            disable(clone, '.friend_rating');
        }

        /* minha lista */

        if (!item.ml_watchlist || item.ml_watched)
        {
            disable(clone, '.watchlist');
        }

        disable(clone, '.watched', !item.ml_watched);
        disable(clone, '.liked', !item.ml_liked);

        if (item.ml_rating)
        {
            clone.querySelector('.rating').textContent = item.ml_rating;
        }
        else
        {
            disable(clone, '.rating');
        }

        container.appendChild(clone);
    });
}

</script>

</body>
</html>